**Интерфейс подключения партнеров**

**к книжному магазину ЛитРес**

Версия документа: 1.88

Дата последнего обновления: 15 октября 2015 г.

Ответственные: Грибов Дмитрий
([admin@litres.ru](mailto:admin@litres.ru)) и Пономаренко Илья
([ponomarenko@litres.ru](mailto:ponomarenko@litres.ru))

Постоянное размещение:
[http://www.litres.ru/static/get\_fresh\_book.zip](http://www.litres.ru/static/get_fresh_book.zip)

***Аннотация***

ЛитРес предлагает партнерам возможность легально торговать электронным
контентом несколькими способами:

1.  **Схема №1**: полностью самостоятельно. При этом партнер оперативно
    получает от нас список новинок (см. раздел 1), файлы книг (см.
    раздел 2) и отдает нам статистику продаж (см. раздел 3). Схема
    работает только для электронных текстов – мультимедиа-контент
    (аудиокниги и др.) на условиях этой схемы недоступен. Учтите, что
    список произведений, допускающих полную передачу, ограничен.
    Фактически, от трети до половины ассортимента будут вам недоступны
    при данной схеме;

2.  **Схема №2**: с каталогом на стороне партнера, но с отдачей файлов с
    сервера ЛитРес. При этом партнер должен подключиться к нашему списку
    новинок (см. 1) и системе уведомлений (см. 4Error: Reference source
    not found). Биллинг работает на стороне партнера, а партнер безналом
    расплачивается с ЛитРес. Подключение по этой схеме допускает продажу
    мультимедиа-контента;

3.  **Схема №3**: с каталогом на стороне ЛитРес. При этом партнер должен
    только разработать дизайн или готовый набор xslt для нашего
    «движка», а все прочие работы выполняются на нашей стороне. Партнер
    при этом занимается исключительно раскруткой своей площадки за
    определенный процент от продаж. При данном подходе весь каталог
    ЛитРес, включая мультимедиа-контент, автоматически доступен
    партнеру.

Содержание {.western lang="ru-RU"}
----------

[1.1.1. Формат запроса 4](#__RefHeading___Toc425961417)

[1.1.2. Формат ответа сервера 5](#__RefHeading___Toc425961418)

[2.1.1. Формат запроса 17](#__RefHeading___Toc425961420)

[2.1.2. Формат ответа сервера 17](#__RefHeading___Toc425961421)

[3.1.1. Формат запроса к серверу партнера
18](#__RefHeading___Toc425961423)

[3.1.2. Формат ответа сервера партнера 18](#__RefHeading___Toc425961424)

[4.1.1. Формат запроса-уведомления от партнера о продаже
20](#__RefHeading___Toc425961426)

[4.1.2. Формат ответа сервера на запрос-уведомление
21](#__RefHeading___Toc425961427)

[4.1.3. Формат URL на скачку книг для пользователей партнера
22](#__RefHeading___Toc425961428)

[4.1.4. Скачивание текстовых книг (тип 0)
22](#__RefHeading___Toc425961429)

[4.1.5. Скачивание книг на английском языке Adobe DRM (тип 11)
24](#__RefHeading___Toc425961430)

[4.1.6. Скачивание мультимедиа-контента (все типы, кроме 0 и 11)
24](#__RefHeading___Toc425961431)

[4.1.7. Время жизни ссылок, число скачиваний
25](#__RefHeading___Toc425961432)

[4.1.8. Перенаправления пользователя при ошибках
25](#__RefHeading___Toc425961433)

[4.1.9. Тестирование интерфейса уведомлений
26](#__RefHeading___Toc425961434)

[6.1.1. Ознакомительные фрагменты для текстовых книг
28](#__RefHeading___Toc425961437)

[6.1.2. Ознакомительные фрагменты для PDF-книг
28](#__RefHeading___Toc425961438)

[6.1.3. Ознакомительные фрагменты для аудио-книг
28](#__RefHeading___Toc425961439)

\

Общие замечания по работе партнеров {.western lang="ru-RU"}
-----------------------------------

-   Этот документ описывает исключительно техническую сторону
    взаимодействия между ЛитРес и партнерами. Юридические,
    организационные и договорные вопросы решаются отдельно. Например, из
    того, что некий способ подключения существует, не следует, что вы
    сможете им воспользоваться. Для обсуждения условий партнерского
    подключения обращайтесь на
    [litres@litres.ru](mailto:litres@litres.ru);

-   Взаимодействие партнера с ЛитРес подразумевает, что ЛитРес не только
    оперативно отдает партнеру контент, но и автоматически уведомляет
    партнера о необходимости **удалить** или **обновить** контент. Если
    партнер своевременно не выполнит запрошенные процедуры
    удаления/обновления, он будет самостоятельно отвечать перед
    правообладателями. Продажа произведений, права на которые были
    отозваны, является пиратством.

Общая информация по сервисам ЛитРес для партнеров {.western lang="ru-RU" style="page-break-before: auto; page-break-after: auto"}
-------------------------------------------------

-   Все текстовые данные передаются и обрабатываются в кодировке UTF-8.
    В том числе это касается вычисления MD5;

-   При взаимодействиях используется протокол HTTP. При всех запросах к
    серверам ЛитРес методы GET и POST взаимозаменяемы, поддерживается
    HTTP 1.1;

-   Дата и время, при отдаче в XML или при передаче на сервер в виде
    параметров запроса, всегда подразумеваются в формате ISO (2008-10-08
    13:29:51) и соответствуют московскому времени;

-   Для всех дробных чисел (к примеру, для цен) в качестве разделителя
    дробной части используется точка. Число 15,50 является
    **не**корректным, а 15.50 и 15.5 являются корректными;

-   Все цены указываются в рублях, любые конвертации при работе партнера
    с другими валютами должны осуществляться на стороне партнера;
    предпочтительно по курсу Центробанка РФ с отклонениями в пределах
    5%;

-   В XML, **помимо** описанного в документации содержимого, может
    размещаться, добавляться и удаляться неограниченное и
    нерегламентированное содержание – узлы, текст и атрибуты. Софт на
    стороне партнера должен корректно отбрасывать и обрабатывать
    ситуации, при которых, например, в документации описана структура
    \<a b="c”\>\<d/\>\</a\>, а фактически возвращается \<a b=”c” y=”x”
    s=”z”\>\<i/\>\<d/\>\<m\>text\</m\>\</a\>. Атрибуты и параметры,
    которые вас интересуют, останутся по прежнему адресу
    **a****/@****b** и **a****/****d**, это мы гарантируем, но
    дополнительное содержимое может (и будет) появляться и пропадать.
    Будьте к этому готовы.

1.  Интерфейс получения списка обновлений {.western lang="ru-RU"}
    -------------------------------------

Для получения списка обновлений используется URL:

[http://partnersdnld.litres.ru/get\_fresh\_book/](http://www.litres.ru/get_fresh_book/)

Этот интерфейс возвращает как, собственно, новые книги, так и книги,
статус которых был изменен. В частности, книга может ***обновиться***,
что должно привести к ее автоматическому обновлению на площадке
партнера. Подобным образом книга может ***из
продаваемой***стать***непродаваемой*** – при этом партнер обязан
немедленно прекратить продажи этой книги (старые покупатели могут
по-прежнему иметь доступ к своим оплаченным копиям). Книга может
получить новую цену, новую аннотацию и т.д. – любые поля могут
обновиться и партнер должен обновить их на своей площадке.

Обновления следует извлекать не чаще одного раза в десять минут и не
реже одного раза в три часа. Рекомендуемая частота обновлений – один раз
в 15 минут. Слишком редкие обновления ведут к проблемам с продажей
«непродаваемых» книг. Особенно болезненно отзываются задержки, если
ответ сервера ЛитРес на уведомление о продаже для партнеров с «витриной
на стороне партнера» (схема №2) игнорируется партнерским ПО. При этом
продажа считается совершенной, несмотря на отказ ЛитРес ее
регистрировать (см. 4), что ведет к невозможности скачать оплаченный
файл.

Запрос списка обновлений (особенно при выборке за большой период,
например при начальной загрузке) занимает на стороне ЛитРес достаточно
много времени, поэтому следует подготовить скрипт к работе с таймаутом
до двадцати (!) минут и исключить повторные запросы до того, как будет
получен ответ на первый запрос.

\

Протестировать процесс загрузки списка обновлений, а также разобраться в
принципах формирования запросов к API вы можете с помощью тестового
файла
[http://www.litres.ru/static/get\_fresh\_book\_tester.html](http://www.litres.ru/static/get_fresh_book_tester.html).

\

1.  ### Формат запроса {.western lang="ru-RU"}

Параметры запроса (все параметры являются обязательными, если не
обозначено обратное):

-   **checkpoint** – время в формате ISO (например, 2015-11-05
    14:48:53), с которого следует забирать новинки. Вы получите список
    новинок со временем большим или равным **checkpoint** и меньшим
    **/****fb****-****updates****/@****timestamp** (см. описание XML
    ниже). Если вы хотите получать непрерывную ленту новинок, сохраняйте
    отданный вам сервером **/****fb****-****updates****/@****timestamp**
    и в следующий раз используйте его в качестве **checkpoint**. Для
    получения полной базы (при первоначальной загрузке) используйте
    чекпойнт «2013-01-01 00:00:00»;

-   **place** – ID партнера. Обычно это четырехбуквенный код, который
    выдается партнеру при заключении договора (см. );

-   **type******– тип запрашиваемого контента, необязательный параметр.
    По-умолчанию подразумевается type=0. Возможные значения:

    -   **0** – электронные тексты/книги;

    -   **1** – аудиокниги;

    -   **4** – PDF-книги;

    -   **11**– Книги на английском языке (Adobe DRM protected);

    -   **all******– все типы произведений. При этом клиент должен
        ожидать, что ему будут выданы произведения, тип которых ему не
        известен.

-   **uuid** – параметр позволяет выдать информацию только по книге с
    конкретным ID; необязательный параметр. См. ниже про
    **updated****-****book****/@****external****\_****id** – уникальный
    ID книги. Параметр **uuid** предназначен для ручной проверки книг и
    его работа в будущем не гарантируется. **uuid** учитывается вместе с
    **checkpoint.** Если вам нужно гарантированно получить XML на
    произведение, используйте **checkpoint**2005-01-01 в сочетании с
    указанием **uuid**;

-   **endpoint** – конец периода, за который запрашивается информация.
    Необязательный параметр. Рекомендуется использовать только при
    получении полной базы обновлений на слабое оборудование. Ограничивая
    запросы месячными периодами, вы сможете избежать обработки
    гигантского XML, за несколько проходов обработав все произведения.
    Формат времени аналогично параметру **checkpoint**.****Параметр
    **endpoint** предназначен для единовременной работы с книгами и его
    работа в будущем не гарантируется;

-   **moreplaces******(актуально только для партнеров с несколькими
    площадками) –названия площадок, перечисленных через запятую, на
    которых необходимо проверить доступность книг. Например:
    «PRTN,TEST». Результат будет размещен в узлах
    **/fb-updates/updated-book/other-place**;

-   **timestamp******– текущий UNIX-таймстамп^[^1^](#sdfootnote1sym)^,
    время в секундах с 00:00:00 UTC 1 января, 1970. Обязательный
    параметр;

-   **sha******– подпись запроса. Формируется как: sha256\_hex
    (**timestamp**.':'.**secret****\_****key**.':'.**checkpoint**) –
    обратите внимание на разделяющие параметры двоеточия. Параметры для
    расчета sha-подписи будут использоваться в том виде, как были
    переданы в запросе, **secret****\_****key** – секретный ключ для
    уведомлений, который передается партнеру при подключении (см. 8).
    Обязательный параметр.

\
Если у вас проблемы с формированием корректного SHA можете
воспользоваться следующей командой для консоли unix:

-   perl -e '\\

\$stamp = 1323780017;\\

\$key="\<secretkey\>";\\

\$checkpoint="2013-11-25 00:00:00";\\

use Digest::SHA;\\

print "\\n\\nGood SHA is:
".Digest::SHA::sha256\_hex("\$stamp:\$key:\$checkpoint")."\\n";'

\

Пример корректного запроса списка новинок (не забудьте изменить
**sheckpoint**, **timestamp** и **sha** на актуальные значения):

[http://partnersdnld.litres.ru/get\_fresh\_book/?checkpoint=2015-10-08%2000:00&place=TEST](http://www.litres.ru/get_fresh_book/?checkpoint=2015-10-08%2000:00&place=TEST%20)&timestamp=1444248000&sha=08d232a196a941a59991c8509d23bd9dd1b5cf1965fb7556258bd6e7d340c3f3

2.  ### Формат ответа сервера {.western lang="ru-RU"}

Новинки выдаются в виде XML. Помимо описанных ниже узлов и атрибутов, в
выдаваемом XML могут быть любые дополнительные данные, которые партнерам
следует игнорировать.

Корневой элемент всегда **fb-updates**. И в корневом элементе всегда
есть атрибут **timestamp**. Пример пустого ответа (если обновлений нет)
выглядит так:

\<fb-updates timestamp="2008-10-08 14:34:05"/\>

В **/fb-updates/@timestamp** передается серверное время (с точностью до
секунды), до которого (не включительно) вы сейчас получаете новинки. Для
получения непрерывного потока обновлений это значение следует сохранять
и при следующем запросе передавать в параметре **checkpoint** (см. 1.1).

\

Каждая новинка передается партнеру в виде узла
**/fb-updates/updated-book**. Вот пример выдачи интерфейса новинок с
одной новинкой и одной удаленной книгой:

\<fb-updates xmlns:l="http://www.w3.org/1999/xlink"
timestamp="2008-10-08 14:43:31"\>

\<updated-book id="143448" created="2008-01-28 17:43:24"
last\_release="2008-08-05 12:31:10" updated="2008-08-05 12:31:10"
valid\_till="2010-01-01 00:00:00" valid\_from="2007-04-09 00:00:00"
size="94789" sent\_by\_name="busya" sent\_by\_id="20" must\_import="0"
options="67" price="9.05" you\_can\_sell="0" allow\_read="1"
allow\_sell="2" allow\_full\_free="0" public\_domain="0"
external\_id="33b10c47-7369-4702-8d8b-f98fedf05798" cover="jpg" type="0"
adult="0" file\_parts="20" wap\_parts="30" contract\_ends="2014-04-05"
chars="141371" images="1" isbn="978-5-425-04925-4"
date\_written\_s="2008" date\_written\_d="2008-08-05"\>

\<files\>

\<file size="94788" type="fb2.zip"/\>

\<file size="83268" type="html.zip"/\>

\<file size="143886" type="txt"/\>

\<file size="53140" type="txt.zip"/\>

\<file size="89612" type="rtf.zip"/\>

\<file size="346854" type="a4.pdf"/\>

\<file size="412475" type="a6.pdf"/\>

\<file size="267782" type="isilo3.pdb"/\>

\<file size="84321" type="doc.prc.zip"/\>

\<file size="98059" type="lit"/\>

\<file size="80859" type="rb"/\>

\<file size="212769" type="mobi.prc"/\>

\<file size="98315" type="lrf"/\>

\<file size="465828" type="epub"/\>

\</files\>

\<book-title title="Карандаш и Самоделкин в Египте"/\>

\<annotation\>

\<p\>В Волшебной школе Карандаша и Самоделкина начались каникулы.
Маленькие волшебники снова собираются в путешествие, но на этот раз они
отправляются в Египет. Друзей ждут опасные приключения и нелегкие
испытания.\</p\>

\<p\>Юные читатели вместе с героями книги встретятся с
кораблем-призраком, настоящими морскими хищниками, смогут пройти самые
запутанные лабиринты и раскрыть секреты пирамиды Тутанхамона.\</p\>

\</annotation\>

\<authors\>

\<author id="ea5cb13b-2a83-102a-9ae1-2dfe723fe7c7"\>

\<subject\_id\>53873\</subject\_id\>

\<url\>valentin-postnikov/\</url\>

\<first-name\>Валентин\</first-name\>

\<last-name\>Постников\</last-name\>

\<full-name-rodit\>Валентина Постникова\</full-name-rodit\>

\<lvl\>4\</lvl\>

\<relation\>0\</relation\>

\</author\>

\</authors\>

\<genres\>

\<genre id="5049" title="Банковское дело"/\>

\<genre id="5334" title="Аттестация персонала"/\>

\</genres\>

\<sequences\>

\<sequence name="Монтгомери и Таггерты"
uuid="d470d52e-09df-11e5-bf8a-002590591ed2" number="1"/\>

\<sequence name="Сумеречные охотники"
uuid="6357ee30-5b5b-11e4-96e2-0025905a06ea"\>

\<sequence name="Адские механизмы"
uuid="6271d19d-5b5b-11e4-96e2-0025905a06ea" number="3"/\>

\</sequence\>

\</sequences\>

\<other-place place="PRTN" you\_can\_sell="1"/\>

\<other-place place="TEST" you\_can\_sell="0"/\>

\</updated-book\>

\<updated-book id="3168025" created="2012-10-26 17:28:18"
updated="2012-10-26 17:28:18" valid\_till="2014-07-01"
valid\_from="2010-10-01" size="486144" sent\_by\_name="palek"
sent\_by\_id="32" must\_import="0" options="70" price="149.00"
you\_can\_sell="0" allow\_read="0" allow\_sell="2" allow\_full\_free="0"
public\_domain="0" show\_card="64" contract\_author="119123"
contract\_title="Аудиокнига (АСТ) (аудио)" subject\_id="64068"
file\_id="4895525" external\_id="54b86e0e-a05e-11e1-aac2-5924aae99221"
cover="jpg" type="1" litres\_isbn="978-5-457-58213-2"
first\_time\_sale="2012-05-28 11:32:48" adult="0" file\_parts="0"
wap\_parts="0" available="1" available\_date="2012-10-26 17:28:09"
copyright\_read\_online="0" contract\_ends="2014-07-01" art\_cover="jpg"
lvl="5" chars="28305"  url="masha-traub/semeynaya-kuhnya-2/"\>

\<files\>

\<group value="Ознакомительный фрагмент. MP3, 128 Kbs" group\_id="1"\>

\<file id="4895525" size="486144" filename="sample.mp3" seconds="28305"
mime\_type="audio/mpeg" file\_description="MP3"/\>

\</group\>

\<group value="Стандартное качество. MP3, 128 Kbps" group\_id="3"\>

\<file id="4895535" size="5989003" filename="Semeinaya\_taina\_01.mp3"
seconds="873" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895545" size="8156597" filename="Semeinaya\_taina\_02.mp3"
seconds="1212" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895555" size="9315154" filename="Semeinaya\_taina\_03.mp3"
seconds="1388" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895565" size="20148540" filename="Semeinaya\_taina\_04.mp3"
seconds="2989" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895575" size="13384882" filename="Semeinaya\_taina\_05.mp3"
seconds="1951" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895585" size="3580018" filename="Semeinaya\_taina\_06.mp3"
seconds="504" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895595" size="5622858" filename="Semeinaya\_taina\_07.mp3"
seconds="808" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895605" size="4164474" filename="Semeinaya\_taina\_08.mp3"
seconds="594" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895615" size="2963923" filename="Semeinaya\_taina\_09.mp3"
seconds="422" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895625" size="5255863" filename="Semeinaya\_taina\_10.mp3"
seconds="760" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895635" size="7592346" filename="Semeinaya\_taina\_11.mp3"
seconds="1095" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895645" size="8126198" filename="Semeinaya\_taina\_12.mp3"
seconds="1159" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895655" size="17467818" filename="Semeinaya\_taina\_13.mp3"
seconds="2524" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895665" size="7759350" filename="Semeinaya\_taina\_14.mp3"
seconds="1105" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895675" size="6298701" filename="Semeinaya\_taina\_15.mp3"
seconds="902" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895685" size="22861277" filename="Semeinaya\_taina\_16.mp3"
seconds="3282" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895695" size="7719468" filename="Semeinaya\_taina\_17.mp3"
seconds="1095" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895705" size="6831524" filename="Semeinaya\_taina\_18.mp3"
seconds="989" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895715" size="10623003" filename="Semeinaya\_taina\_19.mp3"
seconds="1548" mime\_type="audio/mpeg" file\_description="MP3"/\>

\<file id="4895725" size="21392064" filename="Semeinaya\_taina\_20.mp3"
seconds="3105" mime\_type="audio/mpeg" file\_description="MP3"/\>

\</group\>

\<group value="Мобильная версия. MP4, 64 Kbps" group\_id="19"\>

\<file id="4895735" size="204822015" filename="Semeynaya\_tayna.m4b"
seconds="0" mime\_type="audio/m4b" file\_description="M4B-файл"/\>

\</group\>

\<group value="MP3 файлы в zip архиве" group\_id="20"\>

\<file id="4895795" size="168154169" filename="Semeinaya\_taina.zip"
mime\_type="application/zip" file\_description="ZIP - файл"/\>

\</group\>

\</files\>

\<book-title title="Семейная кухня"/\>\
 \<annotation\>

\<p\>

«Семейная кухня» – это не кулинарная книга, а книга о жизни. Жизни,
рассмотренной сквозь призму еды. Друзья, близкие, родственники,
сослуживцы, соседи, дети – со всеми связаны те или иные кулинарные
воспоминания и истории. Так, обычные глазированные сырки могут стать
проводником в детство. Пироги свекрови – недостижимым идеалом. А мамины
беляши – поводом для предложения руки и сердца. Чем накормить будущего
мужа, так, чтобы наверняка сразу позвал замуж? Как выдержать диету?
Может ли котлета, спущенная на ниточке с верхнего этажа, стать оплотом
большой дружбы? Эти и другие забавные, грустные, трогательные и
невероятные истории рассказала Маша Трауб в своей новой книге.

\</p\>

\<p\>

«Эта книга о еде и о людях. Здесь нет рецептов, но есть чувства. Я
вспоминала блюдо и людей, с которыми это блюдо было связано. Эта книга о
тех вкусовых рецепторах, которые отзываются в памяти.

\</p\>

\</annotation\>

\<lang\>ru\</lang\>

\<src\_lang\>en\</src\_lang\>

\<authors\>

\<author id="cfef03d2-06d4-102c-99a2-0288a49f2f10"\>

\<subject\_id\>62968\</subject\_id\>

\<url\>audioagent-audiokniga-ast/\</url\>

\<first-name/\>

\<last-name\>Аудиоагент «Аудиокнига-АСТ»\</last-name\>

\<full-name-rodit/\>

\<lvl\>1\</lvl\>

\<relation\>2\</relation\>

\<exid\>186214\</exid\>

\</author\>

\<author id="6409814c-3cdf-102c-b1cf-18f68bd48621"\>

\<subject\_id\>64068\</subject\_id\>

\<url\>masha-traub/\</url\>

\<first-name\>Маша\</first-name\>

\<last-name\>Трауб\</last-name\>

\<full-name-rodit\>Маши Трауб\</full-name-rodit\>

\<lvl\>5\</lvl\>

\<relation\>0\</relation\>

\</author\>

\<author id="8dc42a51-5859-102c-80c2-5025ca853da2"\>

\<subject\_id\>64389\</subject\_id\>

\<url\>alla-chovzhik/\</url\>

\<first-name\>Алла\</first-name\>

\<last-name\>Човжик\</last-name\>

\<full-name-rodit\>Аллы Човжик\</full-name-rodit\>

\<lvl\>1\</lvl\>

\<relation\>6\</relation\>

\</author\>

\</authors\>

\<genres\>

\<genre id="5049" title="Банковское дело"/\>

\<genre id="5334" title="Аттестация персонала"/\>

\</genres\>

\<other-place place="PRTN" you\_can\_sell="1"/\>

\<other-place place="TEST" you\_can\_sell="0"/\>

\</updated-book\>

\<removed-book id="167151" uid="9ed487d4-9e1d-102b-b665-7cd09fa97345"
removed="2008-07-08 13:34:13"/\>

\</fb-updates\>

\

\

Содержимое узла **updated-book**, существенное для партнеров:

-   **updated****-****book****/@you\_can\_sell** – параметр имеет
    значение больше нуля, если вы можете размещать у себя книгу и 0,
    если не можете. Обратите внимание, что значение может меняться в
    любую сторону и партнерский магазин должен руководствоваться данным
    атрибутом. Так, если книга, которая находится у вас в продаже,
    раньше имела атрибут **you****\_****can****\_****sell** больше нуля,
    а теперь выдает вам **you****\_****can****\_****sell****=”0”**, **вы
    должны немедленно снять книгу с продажи** (карточка книги может при
    этом оставаться, так как сама книга при этом остается в системе).
    Партнерам, не осуществляющим продажи, следует руководствоваться этим
    же атрибутом и размещать или удалять книги в соответствии с ним;

-   **updated****-****book****/@****last****\_****release******– время
    размещения последней версии файла. При изменении **last\_release**
    партнерам, размещающим файлы на своем сервере, следует запросить у
    нас новый файл;

-   **updated****-****book****/@****updated** – время последнего
    «движения» по книге. Меняется при обновлении текста, обложки, прав
    на продажу, смене цены и т.п.;

-   **updated****-****book****/@file\_id** - id текущего файла книги в
    системе. Необходим при извлечении обложки;

-   **updated****-****book****/@****size** – размер ZIP-файла с книгой
    (в байтах);

-   **updated****-****book****/@****adult** – возрастные ограничения на
    книгу (в годах). Значение **0** обозначает, что ограничения
    отсутствуют;

-   **updated****-****book****/@****price** – продажная стоимость книги
    на ЛитРес на данный момент. Партнеру следует быть готовым к тому,
    что цена с течением времени будет изменяться. Цена носит
    рекомендательный характер, но если партнер продает книгу дешевле
    цены ЛитРес, с ЛитРес он всё равно будет рассчитываться исходя из
    указанной здесь цены, доплачивая разницу из своих средств. Поэтому к
    обновлению цены следует относиться внимательно;

-   **updated****-****book****/@****external****\_****id** – уникальный
    ID книги. Используется для глобальной идентификации произведений, в
    частности, при запросе у ЛитРес файла с текстом (см. 2.1.1),
    уведомлениях о продаже (см. 4.1.1) и многих других местах. **ID****–
    строковая переменная**, **не более 50 знаков**. Должен всегда
    обрабатываться и передаваться серверу ЛитРес в **нижнем** регистре
    (это критично при вычислении MD5);

-   **updated****-****book****/@****cover** – строковое значение,
    являющееся признаком наличия у книги обложки. Если строка пустая –
    обложки нет. Если строка не пустая – то она указывает на формат
    оригинальной обложки (**jpg** или **png**). Обложки фиксированных
    размеров всегда имеют формат jpg (см. часть 5);

-   **updated****-****book****/@****file****\_****parts****–**количество
    фрагментов при онлайн-чтении (целочисленное значение);

-   **updated****-****book****/@****wap****\_****parts****–**количество
    фрагментов при мобильном онлайн-чтении (целочисленное значение);

-   **updated****-****book****/@****contract****\_****ends******–
    **примерная** дата окончания контракта на произведение;

-   **updated****-****book****/@****type** – тип произведения. Возможные
    значения:

    -   **0** – текст;

    -   **1** – аудиокнига;

    -   **4**– PDF-книга;

    -   **11**– книга на английском языке (Adobe DRM protected).

-   **updated****-****book****/@****chars******– в зависимости от типа
    произведения, в данном значении содержится различная информация:

    -   **Тип 0** – количество символов в книге (включая пробелы);

    -   **Тип 1** – общая длительность аудиокниги (в секундах);

    -   **Тип 4** – количество страниц в PDF-книге;

-   **updated****-****book****/@****isbn******– один или несколько ISBN
    книги;

-   **updated****-****book****/@****date****\_****written****\_****s******–
    дата написания произведения (строковое значение в свободной форме.
    Но обычно тут хранится год написания книги в формате ГГГГ);

-   **updated****-****book****/@****date****\_****written****\_****d******–
    дата написания произведения в формате ГГГГ-ММ-ДД;

-   **updated****-****book****/@****images******– (актуально для
    произведений с типом 0) – количество изображений в произведении,
    включая обложку. Например, если у произведения с типом 0 в этом
    параметре указано значение «2», то это означает, что в самой книге
    есть только одна иллюстрация;

-   **updated****-****book****/****authors******– раздел, в котором
    описываются все авторы, переводчики, художники, чтецы и другие лица,
    принявшие участие при создании произведения. Для каждого лица
    выделяется отдельный подраздел
    **updated****-****book****/****authors****/author**со списком его
    параметров:

    -   **@****id** – уникальный автора (художника, чтеца и т.п.);

    -   **url******– относительный URL на страницу автора. Например,
        этот пусть можно подставить к своему домену:
        www.litres.ru/\<строкове значение из данного параметра\>;

    -   **first-name**– имя автора;

    -   **last-name**– фамилия автора;

    -   **full****-****name****-****rodit******– имя и фамилия автора в
        родительном падеже;

    -   **lvl******– уровень автора, субъективно выставляемый
        редакторами ЛитРес и отражающий степень известности/интересности
        автора. Параметр может принимать целые значение от 1 до 5 (5 –
        наиболее известные авторы);

    -   **relation******– параметр, определяющий тип лица, принявшего
        участие при создании данного произведения. Возможные значения:

        -   **0** – автор;

        -   **1** – переводчик;

        -   **2** – агент;

        -   **3** – художник;

        -   **4** – составитель;

        -   **5** – пересказчик;

        -   **6** – чтец;

        -   **7** – исполнитель;

        -   **8** – производитель;

        -   **9** – редактор;

        -   **10** – актер;

        -   **11** – режиссер;

        -   **15** – продюсер;

        -   **19** – композитор;

        -   **23** – звукорежиссер;

        -   **27** – сценарист.

-   **updated****-****book****/****genres******– раздел, в котором
    описываются все жанры данного произведения. Каждый жанр представлен
    отдельным узлом
    **updated****-****book****/****genres****/****genre** со следующими
    параметрами:

    -   **@****id** – уникальный ID жанра;

    -   **@****title******– русскоязычное название жанра.

****(Примечание: перечень всех жанров см. в разделе 7).

\

-   **updated****-****book****/****sequences** – раздел, в котором
    описываются все серии книги. Для каждой серии выделяется отдельный
    подраздел
    **updated****-****book****/****authors****/****sequences****/****sequence**
    со списком параметров:

    -   **@****name** – название серии;

    -   **@****number******– поирядковый номер данной книги в серии
        (опционально);

    -   **@uuid**– уникальный идентификатор серии.

Список серий может иметь древовидную/сложенную структуру. В таком случае
книга привязывается к крайним «листам» дерева, например к
**updated****-****book****/****authors****/****sequences****/****sequence****/****sequence****/@****uuid**.

-   **updated****-****book****/****book****-****title****/@****title** –
    название книги;

-   **updated****-****book****/****book****-****title****/@****subtitle**
    – подзаголовок (уточнение) к названию книги;

-   **updated****-****book****/annotation** – текст аннотации
    произведения, разбитый на абзацы тегами \<p\>…\</p\>;

-   **updated****-****book****/****lang****–**язык, на котором написано
    произведение (двухбуквенный код в нижнем регистре в формате ISO).
    Возможные значения:

    -   ru – Русский;

    -   uk – Украинский;

    -   en – Английский;

    -   de – Немецкий;

    -   fr – Французский;

    -   ab – Абхазский;

    -   az – Азербайджанский;

    -   ay – Аймара;

    -   sq – Албанский;

    -   ar – Арабский;

    -   hy – Армянский;

    -   as – Ассамский;

    -   af – Африкаанс;

    -   ts – Банту;

    -   eu – Баскский;

    -   ba – Башкирский;

    -   be – Белорусский;

    -   bn – Бенгальский;

    -   my – Бирманский;

    -   bh – Бихарский;

    -   bg – Болгарский;

    -   br – Бретонский;

    -   cy – Валлийский;

    -   hu – Венгерский;

    -   wo – Волоф;

    -   vi – Вьетнамский;

    -   gd – Гаэльский;

    -   nl – Голландский;

    -   el – Греческий;

    -   ka – Грузинский;

    -   gn – Гуарани;

    -   da – Датский;

    -   gr – Древнегреческий;

    -   iw – Древнееврейский;

    -   dr – Древнерусский;

    -   zu – Зулу;

    -   he – Иврит;

    -   yi – Идиш;

    -   in – Индонезийский;

    -   ia – Интерлингва;

    -   ga – Ирландский;

    -   is – Исландский;

    -   es – Испанский;

    -   it – Итальянский;

    -   kk – Казахский;

    -   kn – Каннада;

    -   ca – Каталанский;

    -   ks – Кашмири;

    -   qu – Кечуа;

    -   ky – Киргизский;

    -   zh – Китайский;

    -   ko – Корейский;

    -   kw – Корнский;

    -   co – Корсиканский;

    -   ku – Курдский;

    -   km – Кхмерский;

    -   xh – Кхоса;

    -   la – Латинский;

    -   lv – Латышский;

    -   lt – Литовский;

    -   mk – Македонский;

    -   mg – Малагасийский;

    -   ms – Малайский;

    -   mt – Мальтийский;

    -   mi – Маори;

    -   mr – Маратхи;

    -   mo – Молдавский;

    -   mn – Монгольский;

    -   na – Науру;

    -   ne – Непали;

    -   no – Норвежский;

    -   pa – Панджаби;

    -   fa – Персидский;

    -   pl – Польский;

    -   pt – Португальский;

    -   ps – Пушту;

    -   rm – Ретороманский;

    -   ro – Румынский;

    -   rn – Рунди;

    -   sm – Самоанский;

    -   sa – Санскрит;

    -   sr – Сербский;

    -   si – Сингальский;

    -   sd – Синдхи;

    -   sk – Словацкий;

    -   sl – Словенский;

    -   so – Сомали;

    -   st – Сото;

    -   sw – Суахили;

    -   su – Сунданский;

    -   tl – Тагальский;

    -   tg – Таджикский;

    -   th – Тайский;

    -   ta – Тамильский;

    -   tt – Татарский;

    -   te – Телугу;

    -   bo – Тибетский;

    -   tr – Турецкий;

    -   tk – Туркменский;

    -   uz – Узбекский;

    -   ug – Уйгурский;

    -   ur – Урду;

    -   fo – Фарерский;

    -   fj – Фиджи;

    -   fi – Финский;

    -   fy – Фризский;

    -   ha – Хауса;

    -   hi – Хинди;

    -   hr – Хорватскосербский;

    -   cs – Чешский;

    -   sv – Шведский;

    -   sn – Шона;

    -   eo – Эсперанто;

    -   et – Эстонский;

    -   jv – Яванский;

    -   ja – Японский.

-   **updated****-****book****/****src****\_****lang****–**язык
    исходного оригинала произведения (двухбуквенный код в нижнем
    регистре в формате ISO). Например, если книга ­- это Шекспировский
    «Гамлет» на русском языке, то в **src****\_****lang******будет «en»,
    а в******src****\_****lang****­-** «ru»;

-   **updated****-****book****/****files****/group/** – (актуально для
    контента с типом 1,4) – список мультимедиа-файлов, связанных с
    данным произведением. Файлы сгруппированы по типу «кодирования»
    (**updated****-****book****/****files****/group/@value**), для
    каждого произведения может быть несколько альтернативных форм.
    Например, для одной книги может быть две группы файлов: «Стандартное
    качество. MP3, 192 Kbps» и «Мобильная версия. MP4, 16 Kbps». Обе
    группы файлов дублируют одно и то же содержание, но при этом
    предоставляют его в разных форматах. \
    Название групп
    **updated****-****book****/****files****/group/@value**могут
    принимать следующие значения:

    -   Для контента с типом 1 (аудиокниги):

        -   Ознакомительный фрагмент. MP3, 128 Kbps;

        -   Копия оригинального диска. MP3-файлы в самораспаковывающемся
            RAR-архиве;

        -   Стандартное качество. MP3, 128 Kbps;

        -   Мобильная версия. MP4, 16 Kbps;

        -   Стандартное качество. MP3, 192 Kbps;

        -   Мобильная версия. MP4, 32 Kbps;

        -   Стандартное качество. MP3, 64 Kbps;

        -   Дополнительные материалы;

        -   Мобильная версия. MP4, 64 Kbps;

        -   MP3 файлы в zip архиве;

    -   Для контента с типом 4 (PDF):

        -   Ознакомительный фрагмент pdf;

        -   PDF-книга;

        -   Обложка в PDF (PoD);

        -   Дополнительные материалы;

Важно понимать, что список названий групп может расширяться и необходимо
корректно обрабатывать все незнакомые значения.

\
Для каждого файла из группы указывается:

-   **@****id** – численный ID файла. При скачивании мультимедиа-файлов
    пользователем (см. 4.1.64.1.6) этот ID передается серверу ЛитРес;

-   **@****size** – размер файла (в байтах);

-   **@filename** – рекомендуемое имя файла;

-   **@****seconds** – длительность (имеет смысл для таких файлов, как
    mp3);

-   **@****mime****\_****type** – тип контента. Возможные значения:

    -   **audio/mpeg** – MP3-файл;

    -   **audio/x-pn-realaudio**– файл Real Audio;

    -   **audio/wav**– WAV-файл;

    -   **audio/x-ms-wma** – WMA-файл;

    -   **audio/m4b** – M4B-файл;

    -   **application/zip**– ZIP-файл;

    -   **application/x-rar-compressed** – RAR-файл;

    -   **application/pdf** – PDF-файл:

Важно понимать, что список типов контента может расширяться и необходимо
корректно обрабатывать все незнакомые значения.

-   **@****file****\_****description** – краткое описание типа файла;

**updated****-****book****/****files****/****file******– (актуально для
контента с типом 0 и 11) – список типов файлов с указанием размера
файла, содержащего электронный текст книги. Для каждого типа файла
указывается:

-   **@****type** – тип файла. \
    Возможные значения для контента типа 0:

    -   fb2.zip;

    -   rtf.zip;

    -   a6.pdf;

    -   a4.pdf;

    -   html.zip;

    -   txt.zip;

    -   rtf.zip;

    -   doc.prc.zip;

    -   rb;

    -   epub;

    -   mobi.prc;

    -   txt;

    -   lrf;

    -   isilo3.pdb;

    -   lit;

    -   ios.epub;

Возможные значения для контента типа 11:

-   epub;

-   a4.pdf;

**@****size** – размер файла в байтах (не указывается для типа 11);

**updated****-****book****/@****contract****\_****author****,****updated****-****book****/@****contract****\_****title**
– числовой ID и текстовое имя правообладателя по данному тексту. Если
**updated****-****book****/@****contract****\_****title** отсутствует,
значит правообладателем является автор. Партнер может указывать имя
правообладателя на своем сайте, чтобы повысить для пользователей и
авторов прозрачность системы;

**updated-book/other-place** – информация о доступности книги на
заданной площадке (см. параметр запроса **moreplaces** в 1.1.1). Таких
узлов в ответе может быть несколько: в зависимости от количества
площадок, указанных в запросе. Каждый узел содержит атрибуты:

-   **@****place** – название площадки, переданной в запросе в параметре
    **moreplaces**;

-   **@****you****\_****can****\_****sell** – разрешение на размещение
    книги на площадке @place. Возможные значения:

    -   **1**– партнер может размещать и продавать эту книгу на площадке
        @place;

    -   **0** – партнеру запрещено размещать эту книгу на площадке
        @place.

\

Помимо информации о новинках, в ответе сервера может содержаться набор
команд **removed-book**. Книги на удаление идентифицируются по fb2-ID в
атрибуте removed-book/@uid и должны быть ***полностью удалены*** из
системы партнера (если они там присутствуют). В том числе и из корзин
уже купивших книгу пользователей.

Инструкции **removed-book** могут иметь атрибут **@s\_uid\_new**, где
хранится новый ID для удаленной книги. В этом случае речь идет не об
удалении, а о замещении книги. И партнер может заменить для уже
оплативших книгу пользователей старую книгу на новую (на стороне ЛитРес
покупки замещаются). Запись о старой книге в любом случае должна быть
удалена.

2.  Интерфейс получения файла книги {.western lang="ru-RU"}
    -------------------------------

Для получения файла книги используется URL:

[http://partnersdnld.litres.ru/get\_the\_book/](http://www.litres.ru/get_the_book/)

1.  ### Формат запроса {.western lang="ru-RU"}

Данный URL принимает запросы с параметрами, которые будут указаны ниже.
В ответ отдается ZIP-архив с fb2-файлом (для электронной книги) или файл
другого формата (если заполнено поле **file**).

\

Параметры запроса (параметры **book**, **md5**, **place**являются
обязательными):

-   **book**– fb2-ID книги (извлекается из
    **updated****-****book****/@****external****\_****id**, подробности
    см. часть 1.2). Обязательный параметр;

-   **md5** – подпись запроса. На Perl ключ генерируется следующим
    образом:\
    lc Digest::MD5::md5\_hex(\$BookID.':'.\$Key); \# где \$Key – ваш
    секретный ключ, который предоставляется партнерам при подключении
    (см. 8). Обратите внимание, что в \$BookID ожидается ID книги в
    **нижнем** регистре. Обязательный параметр;

-   **place** – ID партнера, обычно это четырехбуквенный код (см. 8).
    Обязательный параметр;

-   **type******– необязательный атрибут, указывает формат, в котором
    требуется вернуть файл электронной книги. По умолчанию считается
    fb2.zip, допустимые значения:

    -   fb2.zip;

    -   rtf.zip;

    -   a6.pdf;

    -   a4.pdf;

    -   html.zip;

    -   txt.zip;

    -   rtf.zip;

    -   doc.prc.zip;

    -   rb;

    -   epub;

    -   mobi.prc;

    -   txt;

    -   lrf;

    -   isilo3.pdb;

    -   lit;

    -   ios.epub;

-   **file** – ID файла из
    **updated****-****book****/****files****/****group****/****file****/@****id**
    (1.1.2). Необязательный параметр, используемый для получения PDF и
    аудио файлов (**type** в этом случае заполнять не требуется). Если
    параметр не передан, то в выдачу попадут файлы формата fb2.zip и
    производные от него.

2.  ### Формат ответа сервера {.western lang="ru-RU"}

Сервер отдаст вам запрашиваемый файл соответствующего формата. Из
fb2-файла вы, в последующем, сможете извлечь всю необходимую информацию
о книге, включая полноразмерную обложку, название, список авторов и
прочее. При отдаче файла сервер в поле attachment http-ответа передает
рекомендуемое имя файла (составляется из транслитерированного названия,
серии, фамилии автора и проч.).

3.  Интерфейс отдачи статистики продаж партнерами {.western lang="ru-RU"}
    ---------------------------------------------

Партнеры обязаны предоставлять ЛитРес оперативную статистику (задержка
уведомлений о продажах не более суток) по продажам произведений. Для
получения статистики партнерами, подключенными по схеме №1, используется
http-запрос с нашего сервера на сервер партнера (об отчете при схеме
подключения №2 см. раздел 4.1.1).

Сервер партнера должен в ответ отдать список всех продаж (не статистику,
а именно список продаж). Данные по продажам забираются у партнеров
ежечасно.

1.  ### Формат запроса к серверу партнера {.western lang="ru-RU"}

URL отдачи статистики партнер сообщает нам при подключении (см. ).

HTTP-сервер на указанном URL должен обрабатывать GET запросы со
следующими параметрами:

-   **checkpoint** – время, с точностью до секунды, начиная с которого
    (включительно) следует отдавать список покупок. Предполагается, что
    сервер партнера вернет покупки по [настоящий момент минус одна
    секунда];

-   **md****5** – подпись запроса. Формируется вычислением md5 от
    значения, полученного после конкатенации значения checkpoint и
    секретного ключа. На Perl ключ генерируется следующим образом:\
    lc Digest::MD5::md5\_hex(\$CheckPoint.\$Key); \# где \$Key –
    секретный ключ, предоставляется ЛитРес-у партнером при подключении
    (см. 8).

ЛитРес будет обращаться к URL-у отдачи статистики ежечасно. Ожидается,
что при подстановке в каждый следующий запрос параметра
**litres****-****partner****-****sales****/@****timestamp** в качестве
**checkpoint**, партнер будет отдавать непрерывную и полную статистику.
Без пропусков (обязательно) и без повторов (желательно).

Пример Perl-кода для корректной выборки новых продаж, исключающей
повторы и пропуски:

\

  --------------------------------------------------------------------------------------------------------------------------------------
  \

  my \$CheckPoint=\$query-\>param('checkpoint');

  \

  my \$NowSth=\$dbh-\>prepare("SELECT now()");

  \$NowSth-\>execute();

  my \$EndPoint=\$NowSth-\>fetchrow();

  \

  my \$GetSalesSth=\$dbh-\>prepare("

  SELECT fb2\_id as \`item-id\`, price, time, id as \`pay-id\`

  from sales

  where time \>= ? and time \< ?

  ");

  \

  \$GetSalesSth-\>execute(\$CheckPoint,\$EndPoint);

  \

  print '\<litres-partner-sales partner="PRT" timestamp="'.\$EndPoint.'"\>'. FetchQueryXML(\$GetSalesSth).'\</litres-partner-sales\>';

  \
  --------------------------------------------------------------------------------------------------------------------------------------

2.  ### Формат ответа сервера партнера {.western lang="ru-RU"}

Сервер партнера в ответ на запрос ЛитРес должен отдавать XML, где
корневой элемент имеет имя **litres****-****partner****-****sales**.
Пример ответа сервера партнера:

\<litres-partner-sales checkpoint="2008-09-01 18:00" partner="IMOB"
timestamp="2008-10-08 17:12"\>

\<sale item-id="236C2AF7-38AB-41C4-AE10-F592EDE67F75" price="10.00"
time="2008-09-01 18:45" pay-id="566" currency="RUR"/\>

\<sale item-id="8A7F4723-9F7B-4C97-BF17-130DAB87519A" price="17.00"
time="2008-09-01 19:08" pay-id="567" currency="RUR"/\>

\<sale item-id="03D9D905-3387-4B04-94F5-BEF119059D13" price="3.00"
time="2008-09-02 08:50" pay-id="568" currency="RUR"/\>

\</litres-partner-sales\>

\

Обязательное содержимое тега **litres-partner-sales**:

-   **litres****-****partner****-****sales****/@****timestamp** –
    серверное время, до которого (не включительно) вы отдаете полный
    список продаж;

-   **litres****-****partner****-****sales****/@****partner** – ID
    партнера (см. );

-   **litres****-****partner****-****sales****/****sale** – описание
    одной продажи партнером. Должно иметь следующие атрибуты:

    -   **@****item****-****id** – fb2-ID книги (см.1.1.2,
        **updated****-****book****/@****external****\_****id**);

    -   **@****price** – цена, за которую была продана книга;

    -   **@****time** – время в формате ISO, в которое была завершена
        продажа;

    -   **@****pay****-****id** – уникальный ID платежа в системе
        партнера, который позволит избежать повторного учета платежей;

    -   **@currency**– код валюты. Допускаются значения EUR, USD, GBP,
        AUD, CAD, RUR, NZD. Необязательный атрибут. По умолчанию
        считается равным RUR (российский рубль), а любые значения,
        отличные от рубля, следует явно оговаривать при подключении к
        системе ЛитРес.

\

Использование других валют, кроме рубля, допускается только по
предварительной договоренности с ЛитРес.

\

4.  Интерфейс уведомлений ЛитРес о партнерских продажах {.western lang="ru-RU"}
    ---------------------------------------------------

При способе подключения партнеров, при котором партнеры сами
поддерживают витрину, а скачивание контента клиентами осуществляется с
серверов ЛитРес, необходимо придерживаться следующих требований:

1.  Партнеры выделяют доменное имя, которое будет использоваться для
    отдачи файлов (см. ). Например, партнер, имеющий витрину
    [www.bobook.ru](http://www.bobook.ru/), может выделить домен
    [dnlbook.bobook.ru](http://dnlbook.bobook.ru/) для скачивания книг.
    Этот домен перенаправляется на сервер ЛитРес. Имя этого домена
    необходимо сообщить при подключении к сервису;

2.  Партнер, в процессе продажи (а не после ее завершения!) книги своему
    пользователю, отправляет на сервер ЛитРес уведомление (см. 4.1.1) и
    получает ответ (см. 4.1.2). После того (и только после того!), как
    ЛитРес вернул статус «успех», партнер завершает продажу книги
    пользователю. Если ЛитРес отказывается регистрировать продажу,
    партнер обязан незамедлительно прервать продажу книги пользователю
    (!). Если уведомление прошло успешно, продажа необратимо
    регистрируется в нашей системе и становится мгновенно доступна
    правообладателям;

3.  Книга, продажа которой зарегистрирована на ЛитРес, доступна
    пользователю для скачивания по специальному URL. Ссылка на
    скачивание книг включает MD5-подпись покупателя (см. 4.1.3) и
    направляется партнером на выбранный при подключении домен (см. пункт
    1 выше). В случае, если покупка не была зарегистрирована сервером
    ЛитРес, либо ссылка составлена неверно (неправильный MD5), клиент
    перенаправляется (с 302-м кодом HTTP) на страницу ошибки (см. ),
    указанную партнером при регистрации;

4.  ЛитРес гарантирует обслуживание до 20-и скачиваний любой книги в
    любом формате каждым клиентом. Клики клиентов партнера, исчерпавших
    свой лимит скачивания, перенаправляются (302-й код HTTP) на
    указанную партнером страницу. Счетчик уже совершенных скачиваний
    хранится на сервере ЛитРес и уменьшается на 1 ежемесячно
    (предоставляя максимум 32 закачки в год). Докачка и повторные
    скачивания в течение минуты не наращивают счетчик скачиваний.
    Желательно, чтобы партнер самостоятельно вел счетчик обращений и
    заблаговременно уведомлял своих клиентов о приближении к лимиту
    закачек.

Уведомления о продажах партнера считаются достоверными данными по
продажам и используются ЛитРес для отчета перед правообладателями.
Предоставление партнером статистики согласно разделу 3 для работающих по
схеме №2 партнеров не требуется.

1.  ### Формат запроса-уведомления от партнера о продаже {.western lang="ru-RU"}

Для уведомления о том, что один из пользователей партнера приобрел книгу
и ему следует разрешить скачивание, партнер сразу после продажи
отправляет HTTP-запрос на специальный URL (на зарегистрированном для
него в ЛитРес домене согласно разделу ), например:

[http://www.dnlbook.bobook.ru/partner\_user\_purchases\_a\_book/](http://www.dnlbook.bobook.ru/partner_user_purchases_a_book/).

При этом партнер передает следующие параметры:

-   **user** – обязательный параметр. ID покупателя в системе партнера.
    Далее он используется при формировании URL на скачивание. Целое
    положительное число, не более 4294967295. Если в запросе также
    передается параметр **lfrom**, то значение **user** может быть
    строкой длиной до 128 символов;

-   **art******– обязательный параметр. FB2-ID книги ***в нижнем
    регистре***, которую пользователь приобрел (см.
    **updated****-****book****/@****external****\_****id** в разделе
    1.1.2);

-   **sha******– обязательный параметр. Подпись запроса SHA256. На Perl
    ключ генерируется следующим образом: \
    Digest::SHA::sha256\_hex(\$user.':'.\$art.':'.\$Key); \# , где \$Key
    – секретный ключ для уведомлений партнеру при подключении (см. 8).
    Обратите внимание, что в \$art ожидается ID книги в **нижнем**
    регистре;

-   **price******– обязательный параметр. Цена, по которой партнер
    продал книгу. В случае, если эта цена оказывается ниже цены ЛитРес,
    для взаиморасчетов все равно будет использоваться цена ЛитРес.
    Партнер должен добросовестно указывать свою выручку с продажи.
    Допустим, книга стоит на ЛитРес 10 рублей. Партнер продает эту книгу
    за SMS, отправка SMS обходится пользователю в 50 рублей, из которых
    партнер получает 20 р. При этом партнер должен отчитаться о продаже
    книги за 20 рублей;

-   **mail******– e-mail адрес покупателя. Является обязательным
    параметром за исключением того случая, когда параметр
    reserve=reserve (см ниже). В таком случае параметр mail является
    лишь желательным и позволяет провести валидацию e-mail адреса на
    стороне ЛитРес;

-   **reserve** – необязательный параметр. Признак двухэтапного заказа,
    работы с резервированием. При указании параметра reserve=reserve
    сервер ЛитРес не осуществит покупку для клиента, вместо этого будет
    проверена доступность товара и произведено его *резервирование*. В
    ответе сервера будет передан *ID резерва*. Если в параметре reserve
    передано число, считается что это *ID резерва* и этот резерв
    проводится, как покупка (все остальные параметры так же должны быть
    переданы и соответствовать данным в резерве). Время резервирования –
    **15** минут. Зарезервированный товар гарантированно будет проведен
    как продажа даже в случае, если за это время он был снят с продажи и
    по состоянию на текущий момент уже недоступен;

-   **lfrom** – необязательный параметр. Номер реферала. Партнеру может
    быть выдан номер реферала для регистрации продажи не на сайте
    партнера, а на ЛитРес. В этом случае**lfrom** нужно указывать в
    обязательном порядке, а параметр **user** в этом случае может быть
    строковым идентификатором длиной до 128 символов.

2.  ### Формат ответа сервера на запрос-уведомление {.western lang="ru-RU"}

Сервер ЛитРес выдаёт в ответ на запрос-уведомление результат операции в
виде XML. Варианты ответа:

-   \<response status="0" reserve-id="333333" message="OK"
    reserve-price="89.90"/\> \
     – резервирование успешно. В атрибуте reserve-id передается ID
    резерва, а в reserve-price – справочная рублёвая цена ЛитРес на эту
    книгу на момент оформления резерва;

-   \<response status="0" order-id="333333" message="OK"/\> \
     – продажа успешно зарегистрирована, в order-id внутренний ID
    покупки ЛитРес;

-   \<response status="код\_ошибки" message="текстовое\_сообщение"/\> \
     – произошла ошибка; дается её краткое описание. В этом случае
    ссылка на скачивание данной книги будет «невалидной», а продажа не
    регистрируется. Возможны следующие коды ошибок:

    -   1001 – неправильный MD5;

    -   1002 – неправильный ID книги;

    -   1003 – книга уже куплена (для POD-книг не возвращается);

    -   1004 – книга недоступна для продажи.

Обратите внимание, что ответ за запрос-уведомление может быть «ошибка»,
а не только «ок». При этом не нужно списывать с клиента средства – книгу
он скачать все равно не сможет! Если вы обновляете каталог своевременно,
вероятность отказа в регистрации продажи невелика, но она не равна нулю.
Так же возможен нештатный ответ, например http-ошибка 500 или 503, наш
сервис тоже, случается, недоступен. **Ни в коем случае не списывайте с
клиента средства до того, как получили ответ «ок» на уведомление о
продаже!**

3.  ### Формат URL на скачку книг для пользователей партнера {.western lang="ru-RU"}

4.  ### Скачивание текстовых книг (тип 0) {.western lang="ru-RU"}

Для скачивания текстовой книги с сервера ЛитРес партнер формирует URL
согласно следующим правилам:

-   HTTP запрос с доменом, оговоренном сторонами, и указывающим на
    сервер ЛитРес (см. ) (например,
    [http://dnlbook.bobook.ru](http://dnlbook.bobook.ru/));

-   После доменного имени следует обязательная часть URL:
    /get\_litres\_file/ (например,
    [http://dnlbook.bobook.ru/get\_litres\_file/](http://dnlbook.bobook.ru/get_litres_file/));

\

-   Затем следует текущий UNIX-таймстамп^[^2^](#sdfootnote2sym)^: время
    в секундах с 00:00:00 UTC 1 января, 1970. Ссылка считается валидной,
    если таймстамп не отстал от текущего времени на 12 часов. Ссылки с
    устаревшим таймстампом не обрабатываются. (например,
    [http://dnlbook.bobook.ru/get\_litres\_file/1223476707/](http://dnlbook.bobook.ru/get_litres_file/1223476707/)).
    Для понижения чувствительности URL к рассинхронизации времени между
    сервером партнера и ЛитРес, рекомендуем брать таймстамп,
    просроченный на 60 секунд;

-   Затем следует ID пользователя (например, [http://
    dnlbook.bobook.ru/get\_litres\_file/1223476707/666/](http://www.bobook.ru/));

-   Затем указывается fb2-ID книги ***в нижнем регистре***. В ID могут
    встречаются недопустимые для URL символы, в этом случае URL следует
    «эскейпить». (например,
    [http://dnlbook.bobook.ru/get\_litres\_file/1223476707/666/fb2-test-id-123](http://dnlbook.bobook.ru/get_litres_file/1223476707/666/fb2-test-id-123));

-   Затем, через точку, указывается расширение, выбираемое в зависимости
    от запрошенного пользователем типа файла. Допускаются следующие
    расширения:

    -   **.****fb2.zip** – зипованный FB2;

    -   **.html.zip** – зипованный HTML;

    -   **.****txt.zip** – зипованный TXT;

    -   **.****rtf.zip** – зипованный RTF;

    -   **.****a****4.****pdf** – PDF, оптимизированный для печати на
        A4;

    -   **.****a****6.****pdf** – PDF, оптимизированный для чтения на
        eBook;

    -   **.****isilo****3.****pdb** – формат для iSilo,
        мультиплатформенной старенькой читалки;

    -   **.doc.prc.zip** – файл palm doc. Формат читает множество старых
        и не очень программ;

    -   **.****lit** – формат файлов читалки Microsoft Reader;

    -   **.****rb** – формат для устройства Rocket eBook и REB1100;

    -   **.****epub** – ePub, новый перспективный формат электронных
        книг, разработанный Adobe;

    -   **lrf******– формат, который поддерживают Sony Reader-ы;

    -   **mobi****.****prc** – файлы для моби-ридера. В данный момент
        особенно примечательны тем, что работают на Amazon Kindle, хотя
        для моби есть очень хорошие читалки для PalmOS, Windows Mobile и
        настольных компьютеров.

(например,
[http://www.dnlbook.bobook.ru/get\_litres\_file/1223476707/666/fb2-test-id-123.fb2.zip](http://www.dnlbook.bobook.ru/get_litres_file/1223476707/666/fb2-test-id-123.fb2.zip))

-   В качестве GET или POST параметра к этой ссылке добавляется
    MD5-подпись. На Perl ключ генерируется следующим образом:\
    Digest::MD5::md5\_hex(\$TimeStamp.':'.\$UserID.':'.\$FB2\_id.':'.\$Key);
    \# где \$Key – ваш секретный ключ для скачивания, предоставляется
    партнерам при подключении (см. 8);

(например,
[http://www.dnlbook.bobook.ru/get\_litres\_file/1223476707/666/fb2-test-id-123.fb2.zip?md5=da7c6e3fc60b62ae633d4c6539588ea4](http://www.dnlbook.bobook.ru/get_litres_file/1223476707/666/fb2-test-id-123.fb2.zip?md5=da7c6e3fc60b62ae633d4c6539588ea4)).
Обратите внимание, что в \$FB2\_id ожидается ID книги в **нижнем**
регистре.

Если у вас проблемы с формированием корректного MD5, вы можете
воспользоваться следующей командой для консоли Unix:

-   perl -e '\\

\$time = 1323780017;\\

\$user=5;\\

\$art=lc("c4ca9de1-7457-102b-94c2-fc330996d25d");\\

\$key="\<secretkey\>";\\

use Digest::MD5;\\

print "\\n\\nGood MD5 is:
".Digest::MD5::md5\_hex("\$time:\$user:\$art:\$key")."\\n";'

5.  ### Скачивание книг на английском языке Adobe DRM (тип 11) {.western lang="ru-RU"}

Для скачивания книг на английском языке, защищенных технологией Adobe
DRM (тип 11), партнер формирует URL идентично тому, как формируется URL
для текстовых книг (тип 0), см. п.1.1.1.

\

В ответ на запрос сервер ЛитРес отдает не сам файл, а HTTP-редирект со
статусом 302 на уникальный URL, с которого и будет производиться
скачивание файла лицензии URLLink.acsm (т. е., по сути, книги Adobe
DRM).

\

**Следует обратить особое внимание на следующее:**

-   После уведомления партнером о продаже книги на английском языке
    Adobe DRM (**partner\_user\_purchases\_a\_book**), сервер ЛитРес
    формирует URL, на который будет производится HTTP-редирект (302).
    Формирование URL для Adobe DRM требует некоторого времени, поэтому
    рекомендуется между уведомлением о продаже и запросом на скачивание
    файла сделать паузу **не менее 15 секунд**;

-   Книга на английском языке Adobe DRM может быть скачана **не более 3
    раз**.

6.  ### Скачивание мультимедиа-контента (все типы, кроме 0 и 11) {.western lang="ru-RU"}

Для скачивания мультимедиа-контента с сервера ЛитРес партнер формирует
URL согласно следующим правилам:

-   HTTP запрос с доменом, оговоренном сторонами, и указывающим на
    сервер ЛитРес
    ([http://dnlbook.bobook.ru](http://dnlbook.bobook.ru/));

-   После доменного имени следует обязательная часть URL:
    /get\_litres\_mm\_file/ (например,
    [http://dnlbook.bobook.ru/get\_litres\_mm\_file/](http://dnlbook.bobook.ru/get_litres_mm_file/));

-   Затем следует текущий UNIX-таймстамп^[^3^](#sdfootnote3sym)^, время
    в секундах с 00:00:00 UTC 1 января, 1970. Ссылка считается валидной,
    если таймстамп не отстал от текущего времени на 168 часов (неделя).
    Ссылки с устаревшим таймстампом не обрабатываются (например,
    [http://dnlbook.bobook.ru/get\_litres\_mm\_file/1223476707/](http://dnlbook.bobook.ru/get_litres_mm_file/1223476707/)).
    Для понижения чувствительности URL к рассинхронизации времени между
    сервером партнера и ЛитРес, рекомендуем брать таймстамп,
    просроченный на 60 секунд;

-   Затем следует ID пользователя (например,
    [http://dnlbook.bobook.ru/get\_litres\_mm\_file/1223476707/666/](http://dnlbook.bobook.ru/get_litres_mm_file/1223476707/666/));

-   Затем указывается fb2-ID книги ***в нижнем регистре***. В ID могут
    встречаться недопустимые для URL символы, в этом случае URL следует
    «эскейпить» (например,
    [http://dnlbook.bobook.ru/get\_litres\_mm\_file/1223476707/666/fb2-test-id-123](http://dnlbook.bobook.ru/get_litres_mm_file/1223476707/666/fb2-test-id-123));

-   Затем указывается ID файла (см., 1.1.2, атрибут
    **updated****-****book****/****files****/group/****file****/@****id**).
    Для одной книги таких файлов может быть множество

(например,
[http://dnlbook.bobook.ru/get\_litres\_mm\_file/1223476707/666/fb2-test-id-123/55689](http://dnlbook.bobook.ru/get_litres_mm_file/1223476707/666/fb2-test-id-123/55689));

-   Затем указывается имя файла, переданное в атрибуте
    **updated****-****book****/****files****/group/****file****/@****filename**
    (см. 1.1.2)

(например,
[http://dnlbook.bobook.ru/get\_litres\_mm\_file/1223476707/666/fb2-test-id-123/55689/Filatov\_Rasskazy\_4umnogo\_goroda\_sample.mp3](http://dnlbook.bobook.ru/get_litres_mm_file/1223476707/666/fb2-test-id-123/55689/Filatov_Rasskazy_4umnogo_goroda_sample.mp3));

-   В качестве GET или POST параметра к этой ссылке добавляется
    MD5-подпись, генерируемая аналогично подписи на скачку книги (см.
    2.1.14.1.4). (например,
    [http://dnlbook.bobook.ru/get\_litres\_mm\_file/1223476707/666/fb2-test-id-123/55689/Filatov\_Rasskazy\_4umnogo\_goroda\_sample.mp3](http://dnlbook.bobook.ru/get_litres_mm_file/1223476707/666/fb2-test-id-123/55689/Filatov_Rasskazy_4umnogo_goroda_sample.mp3)?md5=da7c6e3fc60b62ae633d4c6539588ea4).
    Обратите внимание, что в \$FB2\_id ожидается ID книги в **нижнем**
    регистре, а подпись одинакова для всех файлов книги.

7.  ### Время жизни ссылок, число скачиваний {.western lang="ru-RU"}

Партнерские ссылки остаются валидными в течение 12-и часов от указанного
в них таймстампа. Скачивания пользователей теоретически «не
лимитированы», то есть мы не запрещаем добросовестным пользователям
скачивать купленную единожды книгу столько раз и в стольких форматах, в
скольких им нужно. Однако, для предотвращения злоупотреблений существует
фактическое ограничение на 11 повторных скачиваний, причем счетчик
ежемесячно уменьшается на 2. При этом повторными скачиваниями **не**
считаются:

-   Повторные скачивания текстовых книг в течение 3-х минут – с любого
    IP;

-   Повторные скачивания текстовых книг в течение 15-и минут из подсети,
    сформированной из пользовательского IP маской 255.255.255.0;

-   Повторные скачивания текстовых книг в течение одного часа с того же
    IP;

-   Повторные скачивания «не текстовых» книг в течение 8-и часов с
    любого IP;

-   Повторные скачивания «не-текстовых» книг в течение 3-х дней из
    подсети, сформированной из пользовательского IP маской
    255.255.255.0;

-   Повторные скачивания не-текстовых книг в течение недели с того же
    IP.

Данные настройки выбраны методом подбора и на текущий момент полностью
исключают проблемы блокировки скачиваний у добросовестных пользователей.
Партнерам рекомендуется исходить из более жестких правил, особенно в
части касающейся скачивания при смене IP, так как ЛитРес может в
одностороннем порядке изменить данные эвристические настройки в любой
момент без предварительного уведомления.

8.  ### Перенаправления пользователя при ошибках {.western lang="ru-RU"}

Если пользователь обращается на URL скачивания книги, но при этом
происходит ошибка, пользователь перенаправляется на указанный партнером
URL (см. ) с сообщением об ошибке. При этом к URL добавляется параметр
**error**, принимающий следующие значения:

-   **md5** – неверная подпись MD5;

-   **unkownbook** – книга с таким ID сейчас недоступна для скачивания;

-   **not\_purchased** – книга не была продана данному пользователю;

-   **not\_ready\_pending\_acsm** – URL для скачивания книги на
    английском языке Adobe DRM (тип 11), еще не готов. Он находится в
    процессе формирования.

-   **downloads\_overquote** – превышен лимит закачек;

-   **expired** – ссылка содержит просроченный таймстамп (12 часов для
    текстовых книг; 168 для аудио);

-   **internal** – внутренняя ошибка сервиса ЛитРес.

Например, если партнер указал URL
[http://www.partner.ru/dnld\_err/?err=](http://www.partner.ru/dnld_err/?err=)
(см. ) и произошла ошибка вычисления MD5, будет осуществлена
переадресация на:
[http://www.partner.ru/dnld\_err/?err=md5](http://www.partner.ru/dnld_err/?err=md5)

\

9.  ### Тестирование интерфейса уведомлений {.western lang="ru-RU"}

Для тестирования на площадке ЛитРес заведен партнер TEST, домен
tester.litres.ru, а также секретный ключ
**93w4jfhs8imksGo-oa3s85d6Akmkkbnsi9**. Для этого тестового партнера
всегда доступна книга **65830123-26b8-4b07-8098-c18229e5026e**
(Психология Искусства).

\

Протестировать процесс загрузки списка обновлений, а также разобраться в
принципах формирования запросов к API вы можете с помощью тестового
файла
[http://www.litres.ru/static/get\_fresh\_book\_tester.html](http://www.litres.ru/static/get_fresh_book_tester.html).
Затем вы можете скачать этот файл и изменить под свои задачи
тестирования различных запросов.

\

Примеры запросов к API:

\

-   Тестовый URL на запрос уже купленной книги:

[http://tester.litres.ru/partner\_user\_purchases\_a\_book/?user=1&art=65830123-26b8-4b07-8098-c18229e5026e&md5=317bff5f410c2a3b90ffd9d8ad990f9a](http://tester.litres.ru/partner_user_purchases_a_book/?user=1&art=65830123-26b8-4b07-8098-c18229e5026e&md5=317bff5f410c2a3b90ffd9d8ad990f9a)

-   Запрос с некорректным MD5:

[http://tester.litres.ru/partner\_user\_purchases\_a\_book/?user=2&art=65830123-26b8-4b07-8098-c18229e5026e&md5=317bff5f410c2a3b90ffd9d8ad990f9a](http://tester.litres.ru/partner_user_purchases_a_book/?user=2&art=65830123-26b8-4b07-8098-c18229e5026e&md5=317bff5f410c2a3b90ffd9d8ad990f9a)

-   Запрос на покупку книги пользователем 2, который в целях
    тестирования всегда отрабатывает успешно:

[http://tester.litres.ru/partner\_user\_purchases\_a\_book/?user=2&art=65830123-26b8-4b07-8098-c18229e5026e&md5=1cbef90cf0e91e0eebe1a292a244b191](http://tester.litres.ru/partner_user_purchases_a_book/?user=2&art=65830123-26b8-4b07-8098-c18229e5026e&md5=1cbef90cf0e91e0eebe1a292a244b191)

-   Запрос на книгу, которая недоступна партнеру:

[http://tester.litres.ru/partner\_user\_purchases\_a\_book/?user=2&art=65930123-26b8-4b07-8098-c18229e5026e&md5=92dd1dd18c29ac397054ac07ca08135d](http://tester.litres.ru/partner_user_purchases_a_book/?user=2&art=65930123-26b8-4b07-8098-c18229e5026e&md5=92dd1dd18c29ac397054ac07ca08135d)

-   Валидный (но просроченный) URL для пользователя на скачку книги в
    формате PDF:

[http://tester.litres.ru/get\_litres\_file/1227611964/1/65830123-26b8-4b07-8098-c18229e5026e.a4.pdf?md5=f18639249418a8c01f2447816717afd2](http://tester.litres.ru/get_litres_file/1227611964/1/65830123-26b8-4b07-8098-c18229e5026e.a4.pdf?md5=f18639249418a8c01f2447816717afd2)

\

5.  Получение обложек ЛитРес {.western lang="ru-RU"}
    ------------------------

Для большинства (но не для всех!) книг имеются обложки. «Стандартная»
обложка, обычно имеет ширину 250-300 px, но это не гарантированно, т.к.
бывают более широкие или узкие обложки. Ссылку на «стандартное»
изображение обложки партнёр формирует согласно следующим правилам:

-   HTTP запрос к ЛитРес
    ([http://partnersdnld.litres.ru](http://www.litres.ru/));

-   После доменного имени следует обязательная часть URL:
    /static/bookimages/
    ([http://partnersdnld.litres.ru/static/bookimages/](http://www.litres.ru/static/bookimages/));

-   Затем следует получить ID файла книги из списка новинок
    (fb-updates/updated-book/@file\_id) и преобразовать его:

    -   Дополнить нулями, до получения 8-ми знаков вида XXYYZZNN
        (например, 00012345);

    -   Из полученного номера создать путь XX/YY/ZZ/XXYYZZNN.bin.dir/
        (например, 00/01/23/00012345.bin.dir/);

    -   Далее получить полный путь к файлу обложки
        XX/YY/ZZ/XXYYZZNN.bin.dir/XXYYZZNN.cover.jpg (например,
        00/01/23/00012345.bin.dir/00012345.cover.jpg);

-   Сформировать полный URL обложки:
    [http://partnersdnld.litres.ru/static/bookimages/
    XX/YY/ZZ/XXYYZZNN.bin.dir/XXYYZZNN.cover.jpg](http://www.litres.ru/static/bookimages/)
    (например,
    [http://partnersdnld.litres.ru/static/bookimages/00/01/23/00012345.bin.dir/00012345.cover.jpg](http://www.litres.ru/static/bookimages/00/01/23/00012345.bin.dir/00012345.cover.jpg))
    \
    Формат обложки может быть png или jpg, о формате следует узнавать из
    ленты обновлений, см раздел 1.1.2,
    **updated****-****book****/@****cover**;

-   Также существуют версии обложки «фиксированных» размеров – 37, 89 и
    185 пикселей в ширину (высота пропорциональна) и 70, 120 и 140 в
    высоту (ширина пропорциональна). Чтобы получить отформатированную в
    стандартный размер обложку, желаемый размер следует дописать к имени
    файла, XXYYZZNN.cover\_\#.jpg для фиксированной ширины (например,
    00012345.cover\_89.jpg – картинка шириной 89) и
    XXYYZZNN.cover\_h\#.jpg (например, 00012345.cover\_h140.jpg –
    картинка высотой 140). Обложки фиксированного размера всегда имеют
    формат jpg.

6.  Получение ознакомительных фрагментов книг {.western lang="ru-RU"}
    -----------------------------------------

    1.  ### Ознакомительные фрагменты для текстовых книг {.western lang="ru-RU"}

Для всех книг в форматах fb2.zip, a4.pdf, a6.pdf, ePub, rtf.zip, txt,
txt.zip можно получить с сервера ЛитРес ознакомительный фрагмент. Запрос
к ознакомительному фрагменту выглядит так:

[http://partnersdnld.litres.ru/static/trials/00/12/34/00123456.fb2.zip](http://www.litres.ru/static/trials/00/12/34/00123456.fb2.zip),
где 123456 – ID книги (**updated-book/@****id**), a вместо fb2.zip можно
поставить другое расширение.

2.  ### Ознакомительные фрагменты для PDF-книг {.western lang="ru-RU"}

Для **всех** PDF-книг доступны ознакомительные фрагменты. URL для
ознакомительного фрагмента формируется как
[http://partnersdnld.litres.ru/pages/download\_prew/?file=555555](http://www.litres.ru/pages/download_prew/?file=555555),
где 555555 – ID файла из атрибута
**updated****-****book****/@****file****\_****id** (раздел 1.1.2).
Фрагмент является PDF-файлом, обычно содержащим несколько первых страниц
(например, может быть 25 страниц).

3.  ### Ознакомительные фрагменты для аудио-книг {.western lang="ru-RU"}

Для **всех** аудио-книг доступны ознакомительные фрагменты. URL для
ознакомительного фрагмента формируется как
[http://partnersdnld.litres.ru/pages/download\_prew/?file=555555](http://www.litres.ru/pages/download_prew/?file=555555),
где 555555 – ID файла из атрибута
**updated****-****book****/@****file****\_****id** (раздел 1.1.2),
ознакомительный фрагмент представлен mp3-файлом.

7.  Получение дерева жанров ЛитРес {.western lang="ru-RU"}
    ------------------------------

Полное дерево жанров постоянно находится по ссылке
[http://partnersdnld.litres.ru/genres\_list\_2/](http://partnersdnld.litres.ru/genres_list_2/).
Его желательно обновлять раз в две недели или при обнаружении книг с
неизвестными жанрами.

Дерево состоит из корневых жанров (type="root"), непосредственно в
которых или в поджанрах (type="container") расположены конечные жанры
(type="genre").

\

Книгам из каталога всегда присваиваются только конечные жанры из этого
дерева (с атрибутом type="genre"). Но учитывайте, что жанровое дерево
может изменяться и со временем, например, конечные жанры (type="genre")
могут превратиться в поджанры (type="container").

\
Все элементы дерева имеют одинаковые атрибуты:

-   **@****id** – уникальный ID жанра/поджанра;

-   **@****token******– строковой ID жанра/поджанра;

-   **@****title** – русское название жанра/поджанра.

-   **@****type** – тип элемента дерева. Возможные значения:

-   *root* – корневой жанр;

-   *container* – поджанр, условно являющийся «папкой» для конечных
    жанров;

-   *genre* – конечный жанр.

\
Пример выдачи дерева жанров:

\<genres\>

\<genre id="5003" title="Бизнес-книги" type="root"\>

\<genre id="5049" title="Банковское дело" token="bankovskoe\_delo"
type="genre"/\>

\<genre id="5047" title="Кадровый менеджмент"
token="kadrovyj\_menedzhment" type="container"\>

\<genre id="5334" title="Аттестация персонала"
token="attestaciya\_personala" type="genre"/\>

\<genre id="5330" title="Гендерные различия"
token="gendernyye\_razlichiya" type="genre"/\>

\<genre id="5332" title="Конфликты" token="konflikty" type="genre"/\>

\</genre\>

\</genre\>

\<genre id="5013" title="Юмористическая литература" type="root"\>

\<genre id="5201" title="Анекдоты" token="anekdoty" type="genre"/\>

\<genre id="5202" title="Зарубежный юмор" token="zarubezhnyy"
type="genre"/\>

\</genre\>

\</genres\>

\

8.  Данные, передаваемые при подключении партнера {.western lang="ru-RU"}
    ---------------------------------------------

**Данные, предоставляемые партнеру**

  --------------------------------- ------------------------------------ ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  **Параметр**                      **Пример значения**                  **Описание**

  ID партнера                       TEST                                 Строковой ID партнера. Обычно представлен четырьмя символами. Используется при запросе обновлений (см. 1.1.1). Также используется при скачивании файла партнером типа «магазин на стороне партнера» (см. 2.1.1).
                                                                         
                                                                         Выдается партнеру тех. службой «ЛитРес» при заключении договора.

  Секретный ключ                    93w4jfhs8imksGo-oa3s85d6Akmkkbnsi9   Секретный ключ, используемый для MD5-подписи и требуемый при авторизации запросов от партнера к ЛитРес (см. 2.1.1, 3.1.1, 4.1.1, 4.1.3), а также от ЛитРес к партнерам (см. 3.1.1). Выдается партнеру тех. службой «ЛитРес» при заключении договора.

  Пароль для доступа к статистике   8rdj-WKj                             Пароль для доступа к статистике по работе партнера на стороне ЛитРес. Используется стандартное имя пользователя Admin и этот пароль. Для доступа к статистике используется домен для скачивания (см. выше). Выдается партнеру тех. службой «ЛитРес» при заключении договора.
  --------------------------------- ------------------------------------ ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

\

**Данные предоставляемые партнером (необходимо
предоставить****ДО****подключения)**

  --------------------------------------------------- --------------------------------------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  Домен для скачивания\                               dnld\_book.partner.ru                   Доменное имя, принадлежащее партнеру и имеющее перенаправление на partnersdnld.litres.ru. Позволяет полностью скрыть от простого пользователя участия ЛитРес в транзакции – все операции происходят на домене партнера. Партнер выбирает домен и сообщает его ЛитРес. В дальнейшем большая часть транзакций осуществляется партнером на этом домене (см. 4). partnersdnld.litres.ru может резолвиться на несколько IP – это нормально.
  (только для партнеров по схеме №2)                                                          

  URL для редиректа при ошибках\                      http://www.partner.ru/dnld\_err/?err=   При ошибках скачивания клиента сервер ЛитРес будет отправлять редирект на этот URL с добавлением кода ошибки в конец (см. 4.1.8). Передается партнером в тех. службу «ЛитРес».
  (только для партнеров по схеме №2)                                                          

  URL отдачи статистики\                              http://www.partner.ru/litresstats.php   По данному URL ЛитРес будет обращаться с периодичностью \~раз в 30 минут для получения статистики продаж партнера (см. 3).
  (только для партнеров по схеме №1)                                                          

  E-mail для контактов по техническим вопросам        developer@partner.ru                    На этот адрес будут отправлены рассылки с информацией о нововведениях, простоях и другая подобная техническая информация. Помимо e-mail приветствуется указания Skype/ICQ.

  E-mail для контактов по административным вопросам   manager@partner.ru                      Информация по изменениям в условиях работы, по продлениям договора и другим орг. вопросам будет адресоваться на указанный e-mail.
  --------------------------------------------------- --------------------------------------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

\

[1](#sdfootnote1anc) Программисты Windows! Проверьте свои таймстампы на
[http://www.timestampgenerator.com/](http://www.timestampgenerator.com/).
Обратите внимание, что вычислять таймстамп из местного времени нельзя!
Таймстамп считается по UTC и без сдвига летнего/зимнего времени. В
Википедии есть множество подробностей по теории таймстампа, а также есть
огромное количество исходников для любого языка, от Perl до PL/SQL.

[2](#sdfootnote2anc) Программисты Windows! Проверьте свои таймстампы на
http://www.timestampgenerator.com/. Обратите внимание, что вычислять
таймстамп из местного времени нельзя! Таймстамп считается по UTC и без
сдвига летнего/зимнего времени. В Википедии есть множество подробностей
по теории таймстампа, а также есть огромное количество исходников для
любого языка, от Perl до PL/SQL.

[3](#sdfootnote3anc) Программисты Windows! Проверьте свои таймстампы на
[http://www.timestampgenerator.com/](http://www.timestampgenerator.com/).
Обратите внимание, что вычислять таймстамп из местного времени нельзя!
Таймстамп считается по UTC и без сдвига летнего/зимнего времени. В
Википедии есть множество подробностей по теории таймстампа, а также есть
огромное количество исходников для любого языка, от Perl до PL/SQL.

![Группа
33](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAcEAAAAMCAYAAAAaugY2AAAACXBIWXMAAA7AAAAPKwHWnskZAAACFklEQVR4nO3bT0gUYRgG8G+++WYah7UgImxXcqlhhT30TztVh8WDKwh16hKEaEUFdlMIivAoHQojBQ9pEEVkkCjoyWt/DkFgTrTMIahxiUpkmcVmd+ZrvqNC4LSzzErP7zTD8r48t4dheRnnnAAAAAie5zWZpjlEKf0dZi7oEikQeaH4vq+m0+mniUTCinq3wOqxFAAAdqZSqWQEBegahjEZZq5eJeg4zkHbtvOZTOZh1LsFlCAAAGyiKMq6qqprcecQKpVKc1Cufr32owQBAOC/hRIEAICalVcetd8ZnRt6++H70SMjMw/unz3whPEysWZv5gee5y/MPuvp2xN82MWdcyuUIAAA1MiV1sqnlNtT/df1L2OpXP/8eLH38stWWXfajhkrdLqqxJ3wb1CCAABQI5WnOtuXxVOV7yKHch3v9slkQ7xLlHFKSMOeIaAEAQAgGv5P9nrBP33txvFJjRAv7jjbgRIEAIDacYd+mlvMuecuvTmzu7pa8RVZoY1fhMxxnHShULgadxAAAIifuBNMJpOLoYZ4SX5/9/yVi69oX6blhX1P7nRHHt8a7Gja+FE0zcOr9nrr5189+0/uZd/C5pFl2bUsayDoqraws9vBdF3/ms1mR+uxHAAAdh5xJxhqQGr2TgwvTCwPk4nNP2gk1T229LGbLP1rFk3Til0BzsVfi9FjkiRVG+UoEgAAYKvQpRzCH4RbouKjr2yhAAAAAElFTkSuQmCC)\

